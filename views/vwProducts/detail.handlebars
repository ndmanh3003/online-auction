<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  <div class="mb-6">
    <a
      href="javascript:history.back();"
      class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors"
    >
      <i class="fas fa-arrow-left"></i>
      <span>Back</span>
    </a>
  </div>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-12">
    <div>
      <div
        class="bg-white rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-gray-200/60 overflow-hidden mb-4 relative"
      >
        <div
          id="slideshowContainer"
          class="relative w-full h-96 overflow-hidden"
        >
          {{#each product.images}}
          <img
            src="{{this}}"
            alt="{{../product.name}}"
            data-slide-index="{{@index}}"
            class="slideshow-image w-full h-96 object-cover absolute top-0 left-0 transition-opacity duration-500 ease-in-out {{#if @first}}opacity-100{{else}}opacity-0{{/if}}"
          />
          {{/each}}
        </div>
        {{#if (gt product.images.length 1)}}
        <button
          id="prevBtn"
          class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-900 rounded-full w-10 h-10 flex items-center justify-center shadow-lg transition-all duration-300 hover:scale-110 z-10"
        >
          <i class="fas fa-chevron-left"></i>
        </button>
        <button
          id="nextBtn"
          class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-900 rounded-full w-10 h-10 flex items-center justify-center shadow-lg transition-all duration-300 hover:scale-110 z-10"
        >
          <i class="fas fa-chevron-right"></i>
        </button>
        <div
          class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-10"
        >
          {{#each product.images}}
          <button
            data-dot-index="{{@index}}"
            class="slideshow-dot w-2 h-2 rounded-full transition-all duration-300 {{#if @first}}bg-white{{else}}bg-white/50{{/if}} hover:bg-white"
          ></button>
          {{/each}}
        </div>
        {{/if}}
      </div>
      <div class="grid grid-cols-4 gap-4">
        {{#each product.images}}
        <img
          src="{{this}}"
          alt="Product image"
          data-thumb-index="{{@index}}"
          class="thumbnail-image w-full h-24 object-cover rounded-2xl cursor-pointer border-2 border-transparent hover:border-blue-600 transition-all {{#if @first}}border-blue-600{{/if}}"
        />
        {{/each}}
      </div>
    </div>
    <script>
      ;(function () {
        let currentSlide = 0
        let images = []
        let totalSlides = 0
        let slideshowInterval

        function initSlideshow() {
          images = document.querySelectorAll('.slideshow-image')
          totalSlides = images.length

          if (totalSlides <= 1) return

          startSlideshow()
          bindEvents()
        }

        function showSlide(index) {
          currentSlide =
            index < 0 ? totalSlides - 1 : index >= totalSlides ? 0 : index

          images.forEach((img, i) => {
            img.classList.toggle('opacity-100', i === currentSlide)
            img.classList.toggle('opacity-0', i !== currentSlide)
          })

          document.querySelectorAll('.slideshow-dot').forEach((dot, i) => {
            dot.classList.toggle('bg-white', i === currentSlide)
            dot.classList.toggle('bg-white/50', i !== currentSlide)
          })

          document.querySelectorAll('.thumbnail-image').forEach((thumb, i) => {
            thumb.classList.toggle('border-blue-600', i === currentSlide)
          })
        }

        function changeSlide(step) {
          showSlide(currentSlide + step)
          resetSlideshow()
        }

        function startSlideshow() {
          slideshowInterval = setInterval(() => changeSlide(1), 4000)
        }

        function resetSlideshow() {
          clearInterval(slideshowInterval)
          startSlideshow()
        }

        function bindEvents() {
          document
            .getElementById('prevBtn')
            ?.addEventListener('click', () => changeSlide(-1))
          document
            .getElementById('nextBtn')
            ?.addEventListener('click', () => changeSlide(1))

          document.querySelectorAll('.slideshow-dot').forEach((dot, i) =>
            dot.addEventListener('click', () => {
              showSlide(i)
              resetSlideshow()
            })
          )

          document.querySelectorAll('.thumbnail-image').forEach((thumb, i) =>
            thumb.addEventListener('click', () => {
              showSlide(i)
              resetSlideshow()
            })
          )

          const container = document.getElementById('slideshowContainer')
          container?.addEventListener('mouseenter', () =>
            clearInterval(slideshowInterval)
          )
          container?.addEventListener('mouseleave', startSlideshow)
        }

        function tryInit() {
          const container = document.getElementById('slideshowContainer')
          if (
            container &&
            document.querySelectorAll('.slideshow-image').length > 0
          ) {
            initSlideshow()
          } else {
            setTimeout(tryInit, 100)
          }
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', tryInit)
        } else {
          tryInit()
        }
      })()
    </script>
    <div>
      <h1 class="text-[36px] font-semibold text-gray-900 mb-4">
        {{product.name}}
      </h1>
      <a
        href="/products?categoryId={{product.categoryId._id}}"
        class="inline-block text-blue-600 hover:underline mb-6"
      >
        {{product.categoryId.name}}
      </a>
      <div
        class="bg-white rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-gray-200/60 p-6 mb-6"
      >
        <div class="space-y-4">
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Current Price:</span>
            <span class="text-blue-600 font-bold text-2xl"
              >{{format_currency (displayPrice product.currentPrice product.startPrice) }}</span
            >
          </div>
          {{#if product.buyNowPrice}}
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Buy Now Price:</span>
            <span class="text-green-600 font-bold text-xl"
              >{{format_currency product.buyNowPrice }}</span
            >
          </div>
          {{/if}}
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Number of Bids:</span>
            <span class="text-gray-900 font-semibold"
              >{{product.bids.length}}</span
            >
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Ends:</span>
            <span class="text-gray-900 font-semibold"
              >{{formatDate product.endTime }}</span
            >
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Posted:</span>
            <span class="text-gray-900 font-semibold"
              >{{formatDate product.createdAt }}</span
            >
          </div>
        </div>
      </div>
      <div
        class="bg-white rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-gray-200/60 p-6 mb-6"
      >
        <h3 class="text-gray-900 font-semibold mb-4">Seller Information</h3>
        <p class="text-gray-600">{{product.sellerId.name}}</p>
        <p class="text-gray-500 text-sm">{{product.sellerId.email}}</p>
        <div class="mt-4">
          {{#if (gt sellerRatingStats.total 0)}}
          <div class="flex items-center gap-4 mb-2">
            <div class="flex items-center gap-2">
              <i class="fas fa-star text-yellow-500 text-lg"></i>
              <span class="text-gray-900 font-bold text-xl"
                >{{roundPercent sellerRatingStats.percent}}%</span
              >
            </div>
            <div class="text-sm text-gray-600">
              <span class="text-green-600 font-semibold"
                >{{sellerRatingStats.positive}}</span
              >
              /
              <span class="text-red-600 font-semibold"
                >{{sellerRatingStats.negative}}</span
              >
              ({{sellerRatingStats.total}} total)
            </div>
          </div>
          <button
            onclick="openRatingModal_sellerRating('{{product.sellerId._id}}', '{{product.sellerId.name}}')"
            class="text-blue-600 hover:underline text-sm"
          >
            View all ratings →
          </button>
          {{else}}
          <div class="text-gray-500 text-sm">No ratings yet</div>
          {{/if}}
        </div>
      </div>
      {{#if product.currentWinnerId}}
      <div
        class="bg-white rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-gray-200/60 p-6 mb-6"
      >
        <h3 class="text-gray-900 font-semibold mb-4">Current Top Bidder</h3>
        <p class="text-gray-600">
          {{#if isSeller}} {{product.currentWinnerId.name}} {{else}}
          {{maskBidderName product.currentWinnerId.name}} {{/if}}
        </p>
        <div class="mt-4">
          {{> rating/rating-display ratingStats=topBidderRatingStats
          modalId="topBidderRating" userId=product.currentWinnerId._id
          userName=product.currentWinnerId.name compact=false }}
        </div>
      </div>
      {{/if}} {{#if isAuthenticated}}
      {{#if isEnded}}
      {{#if product.currentWinnerId}}
      {{#if (or isSeller (eq authUser._id product.currentWinnerId._id))}}
      <a
        href="/checkout/{{product._id}}"
        class="block text-center px-6 py-4 bg-green-600 text-white rounded-xl shadow-[0_4px_20px_rgba(34,197,94,0.3)] hover:bg-green-700 hover:scale-105 hover:shadow-lg transition-all duration-300 ease-out font-medium mb-3"
      >
        <i class="fas fa-shopping-cart mr-2"></i>View Transaction & Checkout
      </a>
      {{/if}}
      {{/if}}
      <div class="px-6 py-4 bg-gray-100 text-gray-600 rounded-xl text-center font-medium">
        Auction has ended
      </div>
      {{else}}
      <div class="flex gap-2">
        {{#if (eq authUser._id product.sellerId._id)}}
        <button
          disabled
          class="flex-1 px-6 py-4 bg-gray-400 text-white rounded-xl cursor-not-allowed font-medium opacity-60 whitespace-nowrap"
        >
          Add to Watchlist
        </button>
        {{else}}
        <form
          method="post"
          action="/bidder/watchlist/{{product._id}}"
          class="flex-1"
        >
          {{#if isInWatchlist}}
          <input type="hidden" name="_method" value="DELETE" />
          <button
            type="submit"
            class="w-full px-6 py-4 bg-gray-600 text-white rounded-xl shadow-[0_4px_20px_rgba(75,85,99,0.3)] hover:bg-gray-700 hover:scale-105 hover:shadow-lg transition-all duration-300 ease-out font-medium whitespace-nowrap"
          >
            Remove from Watchlist
          </button>
          {{else}}
          <button
            type="submit"
            class="w-full px-6 py-4 bg-yellow-500 text-white rounded-xl shadow-[0_4px_20px_rgba(234,179,8,0.4)] hover:bg-yellow-600 hover:scale-105 hover:shadow-lg transition-all duration-300 ease-out font-medium whitespace-nowrap"
          >
            Add to Watchlist
          </button>
          {{/if}}
        </form>
        {{/if}} {{#if (eq authUser._id product.sellerId._id)}}
        <button
          disabled
          class="flex-1 h-fit text-center px-6 py-4 bg-gray-400 text-white rounded-xl cursor-not-allowed font-medium opacity-60"
        >
          Place Bid
        </button>
        {{else}}
        <button
          onclick="document.getElementById('placeBidModal').classList.remove('hidden')"
          class="flex-1 h-fit text-center px-6 py-4 bg-blue-600 text-white rounded-xl shadow-[0_4px_20px_rgba(37,99,235,0.3)] hover:bg-blue-700 hover:scale-105 hover:shadow-lg transition-all duration-300 ease-out font-medium"
        >
          Place Bid
        </button>
        {{/if}}
      </div>
      {{/if}}
      {{else}}
      <a
        href="/auth/login"
        class="block text-center px-6 py-4 bg-blue-600 text-white rounded-xl shadow-[0_4px_20px_rgba(37,99,235,0.3)] hover:bg-blue-700 hover:scale-105 hover:shadow-lg transition-all duration-300 ease-out font-medium"
      >
        Login to Bid
      </a>
      {{/if}}
      <div class="mt-4">
        <button
          onclick="document.getElementById('bidHistoryModal').classList.remove('hidden')"
          class="block w-full text-center px-6 py-4 bg-white text-gray-900 border border-gray-200/60 rounded-xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] hover:bg-gray-50 hover:scale-105 transition-all duration-300 ease-out font-medium"
        >
          View Bid History
        </button>
      </div>
    </div>
  </div>
  <div
    class="bg-white rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-gray-200/60 p-8 mb-12"
  >
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-[28px] font-semibold text-gray-900">Description</h2>
      {{#if isAuthenticated}} {{#if (eq authUser._id product.sellerId._id)}}
      <button
        onclick="document.getElementById('appendDescModal').classList.remove('hidden')"
        class="text-blue-600 hover:text-blue-700 font-medium text-sm flex items-center gap-1"
      >
        <i class="fas fa-plus-circle"></i>
        <span>Append Description</span>
      </button>
      {{/if}} {{/if}}
    </div>
    <div class="text-gray-600 prose max-w-none">{{{product.description}}}</div>
    {{#if product.appendedDescriptions.length}} {{#each
    product.appendedDescriptions}}
    <hr class="my-8 border-t border-gray-200" />
    <div class="mb-6">
      <div class="flex items-center gap-2 mb-3">
        <i class="fas fa-edit text-blue-600"></i>
        <span class="text-gray-500 text-sm">{{formatDate timestamp}}</span>
      </div>
      <div class="text-gray-600 prose max-w-none">{{{content}}}</div>
    </div>
    {{/each}} {{/if}}
  </div>
  <div
    class="bg-white rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-gray-200/60 p-8 mb-12"
  >
    <h2 class="text-[28px] font-semibold text-gray-900 mb-6">
      Questions & Answers
    </h2>
    {{#if isAuthenticated}}
    <form method="post" action="/bidder/question/{{product._id}}" class="mb-8">
      <div class="relative mb-4">
        <textarea
          name="question"
          rows="3"
          class="w-full px-4 py-4 border border-gray-200/60 rounded-2xl focus:ring-2 focus:ring-black/10 focus:outline-none transition-all duration-300 text-gray-900"
          placeholder="Ask a question about this product..."
          required
        ></textarea>
      </div>
      <button
        type="submit"
        class="px-6 py-3 bg-blue-600 text-white rounded-xl shadow-[0_4px_20px_rgba(37,99,235,0.3)] hover:bg-blue-700 hover:scale-105 hover:shadow-lg transition-all duration-300 ease-out font-medium"
      >
        Submit Question
      </button>
    </form>
    {{/if}} {{#if product.questions.length}}
    <div class="space-y-6">
      {{#each product.questions}}
      <div class="border-b border-gray-200 pb-6 last:border-b-0">
        <div class="flex items-start gap-4 mb-4">
          <div class="flex-1">
            <p class="text-gray-900 font-medium">{{askerId.name}}</p>
            <p class="text-gray-600 mt-2">{{question}}</p>
            <p class="text-gray-400 text-sm mt-1">{{formatDate createdAt }}</p>
          </div>
        </div>
        {{#if answer}}
        <div class="ml-8 bg-blue-50 rounded-2xl p-4">
          <p class="text-gray-900 font-medium mb-2">Seller's Response:</p>
          <p class="text-gray-600">{{answer}}</p>
          <p class="text-gray-400 text-sm mt-1">{{formatDate answeredAt }}</p>
        </div>
        {{/if}}
      </div>
      {{/each}}
    </div>
    {{else}}
    <p class="text-gray-500 text-center py-8">
      No questions yet. Be the first to ask!
    </p>
    {{/if}}
  </div>
  {{#if product.relatedProducts.length}}
  <div class="mb-12">
    <h2 class="text-[28px] font-semibold text-gray-900 mb-6">
      Related Products
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {{#each product.relatedProducts}}
      <div
        class="bg-white rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-gray-200/60 overflow-hidden hover:scale-105 transition-all duration-300 ease-out"
      >
        <a href="/products/{{_id}}">
          <img
            src="{{images.[0]}}"
            alt="{{name}}"
            class="w-full h-48 object-cover"
          />
        </a>
        <div class="p-4">
          <a href="/products/{{_id}}" class="block">
            <h3 class="text-gray-900 font-semibold mb-2 truncate">{{name}}</h3>
          </a>
          <a
            href="/products?categoryId={{categoryId._id}}"
            class="inline-block mb-2"
          >
            <span
              class="inline-flex items-center gap-1 px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium hover:bg-gray-200 transition-colors"
            >
              <i class="fas fa-tag"></i>
              {{categoryId.name}}
            </span>
          </a>
          <p class="text-blue-600 font-bold">
            {{format_currency (displayPrice currentPrice startPrice) }}
          </p>
        </div>
      </div>
      {{/each}}
    </div>
  </div>
  {{/if}}
</div>
{{#> modal id="bidHistoryModal" title="Bid History"}} {{#if bids.length}}
<div class="overflow-x-auto">
  <table class="w-full">
    <thead>
      <tr class="border-b border-gray-200">
        <th class="text-left py-3 px-4 text-gray-900 font-semibold text-sm">
          Date & Time
        </th>
        <th class="text-left py-3 px-4 text-gray-900 font-semibold text-sm">
          Bidder
        </th>
        <th class="text-right py-3 px-4 text-gray-900 font-semibold text-sm">
          Bid Amount
        </th>
        {{#if isSeller}}
        <th class="text-center py-3 px-4 text-gray-900 font-semibold text-sm">
          Action
        </th>
        {{/if}}
      </tr>
    </thead>
    <tbody>
      {{#each bids}}
      <tr
        class="border-b border-gray-100 hover:bg-gray-50 transition-colors {{#if isBlocked}}opacity-50{{/if}}"
      >
        <td class="py-3 px-4 text-gray-600 text-sm">
          {{formatDate createdAt}}
        </td>
        <td class="py-3 px-4">
          <div class="flex flex-col gap-1">
            <div class="flex items-center gap-2">
              <span class="text-gray-900 font-medium text-sm">
                {{#if ../isSeller}} {{bidderId.name}} {{else}} {{maskBidderName
                bidderId.name}} {{/if}}
              </span>
              {{#if isBlocked}}
              <span
                class="inline-block px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium"
              >
                Blocked
              </span>
              {{/if}}
            </div>
            {{#if bidderId.ratingStats}} {{#if (gt bidderId.ratingStats.total
            0)}}
            <div class="inline-flex items-center gap-1 text-xs">
              <i class="fas fa-star text-yellow-500"></i>
              <span class="font-semibold text-gray-900"
                >{{roundPercent bidderId.ratingStats.percent}}%</span
              >
              <span class="text-gray-500"
                >({{bidderId.ratingStats.positive}}/{{bidderId.ratingStats.total}})</span
              >
            </div>
            {{else}}
            <span class="text-xs text-gray-400">No ratings</span>
            {{/if}} {{/if}}
          </div>
        </td>
        <td class="py-3 px-4 text-right">
          <span class="font-bold text-blue-600">
            {{format_currency bidAmount}}
          </span>
        </td>
        {{#if ../isSeller}}
        <td class="py-3 px-4 text-center">
          {{#unless isBlocked}}
          <form
            method="post"
            action="/seller/products/{{@root.product._id}}/block/{{bidderId._id}}"
            onsubmit="event.preventDefault(); customConfirm('Are you sure you want to block this bidder?').then(result => { if(result) this.submit(); });"
          >
            <button
              type="submit"
              class="px-3 py-1 bg-red-600 text-white text-xs rounded-lg hover:bg-red-700 transition-colors font-medium"
            >
              Block
            </button>
          </form>
          {{else}}
          <span class="text-gray-400 text-xs">Blocked</span>
          {{/unless}}
        </td>
        {{/if}}
      </tr>
      {{/each}}
    </tbody>
  </table>
</div>
{{else}}
<div class="text-center py-12">
  <i class="fas fa-gavel text-gray-400 text-5xl mb-4"></i>
  <p class="text-gray-600">No bids yet. Be the first to bid!</p>
</div>
{{/if}} {{/modal}} {{#if (eq authUser._id product.sellerId._id)}} {{#> modal
id="appendDescModal" title="Append Description"}}
<form
  method="post"
  action="/seller/products/{{product._id}}/append"
  class="space-y-4"
  id="appendForm"
>
  <div>
    <label
      for="description"
      class="block text-sm font-medium text-gray-900 mb-2"
      >Additional Description</label
    >
    <div
      id="editor"
      class="bg-white max-h-[300px] border border-gray-200/60 rounded-2xl"
    ></div>
    <input type="hidden" id="description" name="description" />
    <p class="text-gray-500 text-sm mt-2">
      This will be added to the existing description with a timestamp.
    </p>
  </div>
  <button
    type="submit"
    class="w-full px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium"
  >
    Append Description
  </button>
</form>
{{/modal}} {{#section "css"}}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
{{/section}} {{#section "js"}}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
  var quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: 'Enter additional information to append to the description...',
    modules: {
      toolbar: [
        [{ header: [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ list: 'ordered' }, { list: 'bullet' }],
        [{ color: [] }, { background: [] }],
        [{ align: [] }],
        ['link', 'image'],
        ['clean'],
      ],
    },
  })

  var form = document.getElementById('appendForm')
  form.onsubmit = function (e) {
    var descriptionInput = document.getElementById('description')
    var content = quill.root.innerHTML
    var text = quill.getText().trim()

    if (!text || text === '' || content === '<p><br></p>') {
      e.preventDefault()
      alert('Please enter additional description')
      return false
    }

    descriptionInput.value = content
    return true
  }
</script>
{{/section}} {{/if}} {{#if isAuthenticated}} {{#unless isSeller}} {{#> modal
id="placeBidModal" title="Place a Bid"}}
<div class="mb-4">
  <p class="text-gray-900 font-medium text-lg">{{product.name}}</p>
</div>
<div class="mb-4 p-4 bg-blue-50 rounded-xl">
  <div class="space-y-2">
    <div class="flex justify-between items-center">
      <span class="text-gray-600">Current Price:</span>
      <span class="text-blue-600 font-bold text-xl"
        >{{format_currency (displayPrice product.currentPrice product.startPrice)}}</span
      >
    </div>
    <div class="flex justify-between items-center">
      <span class="text-gray-600">Step Price:</span>
      <span class="text-gray-900 font-semibold"
        >{{format_currency product.stepPrice}}</span
      >
    </div>
    <div class="flex justify-between items-center">
      <span class="text-gray-600">Minimum Bid:</span>
      <span class="text-green-600 font-bold text-lg"
        >{{format_currency minBidAmount}}</span
      >
    </div>
  </div>
</div>
<form method="post" action="/bidder/bid/{{product._id}}" class="space-y-4">
  {{#if userBid}}
  <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl mb-4">
    <p class="text-blue-800 text-sm font-medium mb-1">
      You have already placed a bid
    </p>
    <p class="text-blue-600 text-sm">
      Current maximum bid: {{format_currency userBid.maxBidAmount}}
    </p>
  </div>
  {{/if}}
  <div>
    <label
      for="maxBidAmount"
      class="block text-sm font-medium text-gray-900 mb-2"
      >{{#if userBid}}Update Maximum Auto-Bid Amount{{else}}Maximum Auto-Bid
      Amount (Required){{/if}}</label
    >
    <input
      type="text"
      id="maxBidAmount"
      name="maxBidAmount"
      class="w-full px-4 py-3 border border-gray-200/60 rounded-xl focus:ring-2 focus:ring-black/10 focus:outline-none transition-all duration-300 text-gray-900"
      placeholder="Enter maximum auto-bid amount"
      inputmode="numeric"
      data-min-bid="{{minBidAmount}}"
      data-step-price="{{product.stepPrice}}"
    />
    <p class="text-gray-500 text-sm mt-1">
      System will automatically bid up to this amount for you. Minimum:
      {{format_currency minBidAmount}}. Must be a multiple of step price
      ({{format_currency product.stepPrice}}).
    </p>
    <p id="bidAmountError" class="text-red-600 text-sm mt-1 hidden"></p>
  </div>
  <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-xl">
    <p class="text-gray-700 text-sm">
      <strong>Note:</strong> By placing a bid, you agree to purchase this item
      if you win. {{#if product.autoExtend}} This auction has auto-extend
      enabled. {{/if}}
    </p>
  </div>
  <button
    type="button"
    id="openConfirmBidBtn"
    class="w-full px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium"
  >
    {{#if userBid}}Update Maximum Bid{{else}}Place Bid{{/if}}
  </button>
</form>
{{/modal}} {{/unless}} {{/if}} {{#> modal id="confirmBidModal" title="Confirm
Your Bid"}}
<div class="space-y-6">
  <div class="text-center">
    <div
      class="mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4"
    >
      <i class="fas fa-gavel text-blue-600 text-2xl"></i>
    </div>
    <p class="text-gray-900 font-medium text-lg mb-2">
      Are you sure you want to place this bid?
    </p>
    <p class="text-gray-600 text-sm">
      The system will automatically bid up to your maximum amount.
    </p>
  </div>
  <div class="bg-gray-50 rounded-2xl p-6 space-y-4">
    <div class="flex justify-between items-center">
      <span class="text-gray-600 font-medium">Maximum Auto-Bid Amount:</span>
      <span class="text-blue-600 font-bold text-xl" id="confirmMaxBidAmount"
        >0 đ</span
      >
    </div>
    <div class="flex justify-between items-center">
      <span class="text-gray-600 font-medium">Current Price:</span>
      <span class="text-gray-900 font-semibold" id="confirmCurrentPrice"
        >0 đ</span
      >
    </div>
    <div class="flex justify-between items-center">
      <span class="text-gray-600 font-medium">Minimum Bid:</span>
      <span class="text-green-600 font-semibold" id="confirmMinBid">0 đ</span>
    </div>
  </div>
  <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
    <p class="text-yellow-800 text-sm">
      <i class="fas fa-info-circle mr-2"></i>
      <strong>Note:</strong> By placing a bid, you agree to purchase this item
      if you win.
    </p>
  </div>
  <div class="flex gap-4">
    <button
      type="button"
      id="cancelBidBtn"
      class="flex-1 px-6 py-3 bg-gray-200 text-gray-900 rounded-xl hover:bg-gray-300 transition-all duration-300 ease-out font-medium"
    >
      Cancel
    </button>
    <button
      type="button"
      id="confirmBidBtn"
      class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-xl shadow-[0_4px_20px_rgba(37,99,235,0.3)] hover:bg-blue-700 hover:scale-105 hover:shadow-lg transition-all duration-300 ease-out font-medium"
    >
      Confirm Bid
    </button>
  </div>
</div>
{{/modal}} {{> rating/rating-history-modal modalId="sellerRating" title="Seller
Rating History" userId="" userName="" }} {{#if product.currentWinnerId}} {{>
rating/rating-history-modal modalId="topBidderRating" title="Top Bidder Rating
History" userId=product.currentWinnerId._id
userName=product.currentWinnerId.name }} {{/if}} {{#section 'js'}}
<script>
  function formatCurrency(value) {
    if (!value) return ''
    var num = value.toString().replace(/[^\d]/g, '')
    if (!num) return ''
    return new Intl.NumberFormat('vi-VN').format(parseInt(num))
  }

  function parseCurrency(value) {
    if (!value) return 0
    return parseInt(value.toString().replace(/[^\d]/g, '')) || 0
  }

  var bidFormSubmitHandler = null
  var bidFormInitialized = false
  var openConfirmBidBtnHandler = null

  function initBidAmountInput() {
    var maxBidAmountInput = document.getElementById('maxBidAmount')
    if (!maxBidAmountInput) return

    var rawValue = maxBidAmountInput.getAttribute('data-raw-value')
    if (rawValue) {
      maxBidAmountInput.value = formatCurrency(rawValue)
    }

    maxBidAmountInput.addEventListener('input', function (e) {
      var cursorPos = e.target.selectionStart
      var oldValue = e.target.value
      var newValue = formatCurrency(e.target.value)
      e.target.value = newValue
      var diff = newValue.length - oldValue.length
      e.target.setSelectionRange(cursorPos + diff, cursorPos + diff)
    })
  }

  function validateBidAmount() {
    var maxBidAmountInput = document.getElementById('maxBidAmount')
    if (!maxBidAmountInput) return false

    var inputValue = maxBidAmountInput.value.trim()
    if (!inputValue) {
      if (window.showError) {
        window.showError('Please enter a maximum bid amount.')
      } else {
        alert('Please enter a maximum bid amount.')
      }
      return false
    }

    var parsedValue = parseCurrency(inputValue)
    if (parsedValue <= 0) {
      if (window.showError) {
        window.showError('Maximum bid amount must be greater than 0.')
      } else {
        alert('Maximum bid amount must be greater than 0.')
      }
      return false
    }

    var minBid = parseInt(maxBidAmountInput.getAttribute('data-min-bid')) || 0
    var stepPrice =
      parseInt(maxBidAmountInput.getAttribute('data-step-price')) || 0

    var bidForm = maxBidAmountInput.closest('form')
    var currentPriceEl = bidForm
      ?.closest('.modal')
      ?.querySelector('.text-blue-600.font-bold')
    var currentPrice = currentPriceEl
      ? parseCurrency(currentPriceEl.textContent)
      : 0

    if (parsedValue < minBid) {
      if (window.showError) {
        window.showError(
          'Maximum bid amount must be at least ' + formatCurrency(minBid) + ' đ'
        )
      } else {
        alert(
          'Maximum bid amount must be at least ' + formatCurrency(minBid) + ' đ'
        )
      }
      return false
    }

    if (stepPrice > 0 && currentPrice > 0) {
      var bidIncrement = parsedValue - currentPrice
      if (bidIncrement < 0) {
        if (window.showError) {
          window.showError(
            'Maximum bid amount must be greater than current price (' +
              formatCurrency(currentPrice) +
              ' đ)'
          )
        } else {
          alert(
            'Maximum bid amount must be greater than current price (' +
              formatCurrency(currentPrice) +
              ' đ)'
          )
        }
        return false
      }

      var remainder = bidIncrement % stepPrice
      if (remainder !== 0) {
        var nextValidBid =
          currentPrice + Math.ceil(bidIncrement / stepPrice) * stepPrice
        if (window.showError) {
          window.showError(
            'Bid increment must be a multiple of step price (' +
              formatCurrency(stepPrice) +
              ' đ). For example: ' +
              formatCurrency(currentPrice + stepPrice) +
              ' đ, ' +
              formatCurrency(currentPrice + stepPrice * 2) +
              ' đ, ' +
              formatCurrency(currentPrice + stepPrice * 3) +
              ' đ, etc. Suggested: ' +
              formatCurrency(nextValidBid) +
              ' đ'
          )
        } else {
          alert(
            'Bid increment must be a multiple of step price (' +
              formatCurrency(stepPrice) +
              ' đ). Suggested: ' +
              formatCurrency(nextValidBid) +
              ' đ'
          )
        }
        return false
      }
    }

    return true
  }

  function openConfirmModal() {
    var maxBidAmountInput = document.getElementById('maxBidAmount')
    if (!maxBidAmountInput) return

    var bidForm = maxBidAmountInput.closest('form')
    if (!bidForm) return

    var parsedValue = parseCurrency(maxBidAmountInput.value.trim())
    var currentPriceEl = bidForm
      .closest('.modal')
      ?.querySelector('.text-blue-600.font-bold')
    var currentPrice = currentPriceEl
      ? parseCurrency(currentPriceEl.textContent)
      : 0
    var minBid = parseInt(maxBidAmountInput.getAttribute('data-min-bid')) || 0

    var confirmBidModal = document.getElementById('confirmBidModal')
    var confirmMaxBidAmount = document.getElementById('confirmMaxBidAmount')
    var confirmCurrentPrice = document.getElementById('confirmCurrentPrice')
    var confirmMinBid = document.getElementById('confirmMinBid')

    if (confirmMaxBidAmount) {
      confirmMaxBidAmount.textContent = formatCurrency(parsedValue) + ' đ'
    }
    if (confirmCurrentPrice) {
      confirmCurrentPrice.textContent = formatCurrency(currentPrice) + ' đ'
    }
    if (confirmMinBid) {
      confirmMinBid.textContent = formatCurrency(minBid) + ' đ'
    }

    if (confirmBidModal) {
      confirmBidModal.classList.remove('hidden')
    }
  }

  function initBidForm() {
    var maxBidAmountInput = document.getElementById('maxBidAmount')
    if (!maxBidAmountInput) return

    var bidForm = maxBidAmountInput.closest('form')
    if (!bidForm) return

    var openConfirmBidBtn = document.getElementById('openConfirmBidBtn')
    if (openConfirmBidBtn) {
      if (openConfirmBidBtnHandler) {
        openConfirmBidBtn.removeEventListener('click', openConfirmBidBtnHandler)
      }

      openConfirmBidBtnHandler = function (e) {
        e.preventDefault()
        e.stopPropagation()
        if (validateBidAmount()) {
          openConfirmModal()
        }
        return false
      }

      openConfirmBidBtn.addEventListener('click', openConfirmBidBtnHandler)
      bidFormInitialized = true
    }

    var confirmBidModal = document.getElementById('confirmBidModal')
    var confirmBidBtn = document.getElementById('confirmBidBtn')
    var cancelBidBtn = document.getElementById('cancelBidBtn')

    function hideConfirmModal() {
      if (confirmBidModal) {
        confirmBidModal.classList.add('hidden')
      }
    }

    function submitBid() {
      var parsedValue = parseCurrency(maxBidAmountInput.value)
      maxBidAmountInput.value = parsedValue.toString()
      hideConfirmModal()
      bidForm.submit()
    }

    if (confirmBidBtn) {
      confirmBidBtn.addEventListener('click', function () {
        submitBid()
      })
    }

    if (cancelBidBtn) {
      cancelBidBtn.addEventListener('click', function () {
        hideConfirmModal()
      })
    }

    if (confirmBidModal) {
      confirmBidModal.addEventListener('click', function (e) {
        if (e.target === confirmBidModal) {
          hideConfirmModal()
        }
      })
    }
  }

  var placeBidModal = document.getElementById('placeBidModal')
  if (placeBidModal) {
    var observer = new MutationObserver(function (mutations) {
      mutations.forEach(function (mutation) {
        if (
          mutation.type === 'attributes' &&
          mutation.attributeName === 'class'
        ) {
          if (!placeBidModal.classList.contains('hidden')) {
            setTimeout(function () {
              initBidAmountInput()
              initBidForm()
            }, 50)
          }
        }
      })
    })
    observer.observe(placeBidModal, {
      attributes: true,
      attributeFilter: ['class'],
    })
  }

  var placeBidBtn = document.querySelector('button[onclick*="placeBidModal"]')
  if (placeBidBtn) {
    var originalOnClick = placeBidBtn.getAttribute('onclick')
    placeBidBtn.removeAttribute('onclick')
    placeBidBtn.addEventListener('click', function () {
      eval(originalOnClick)
      setTimeout(function () {
        initBidAmountInput()
        bidFormInitialized = false
        initBidForm()
      }, 50)
    })
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function () {
      initBidAmountInput()
      initBidForm()
    })
  } else {
    initBidAmountInput()
    initBidForm()
  }
</script>
{{/section}}
