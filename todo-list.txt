HỆ THỐNG ĐẤU GIÁ ONLINE – TODO LIST + LOGIC CHI TIẾT
(Dựa trên đề bài chính thức và file luu-y.txt)

================================================================================
1. USER – AUTH – ROLE
================================================================================
1.1 Đăng ký / Đăng nhập
• User đăng ký mới → role mặc định = Bidder
• Lưu thông tin:
  - id, name, email, password_hash, address, dob
• Xác thực email bằng OTP
• reCAPTCHA validation
• Đăng nhập thành công → tạo session

1.1.1 Đăng nhập với Google OAuth (Bổ sung)
• Hỗ trợ đăng nhập/đăng ký qua Google OAuth 2.0
• Logic xử lý:
  - IF email chưa tồn tại trong hệ thống
    → Tự động tạo account mới
    → role = 'bidder'
    → isEmailVerified = true (Google đã verify)
  - IF email đã tồn tại
    → Đăng nhập vào account hiện có
• Lưu thêm:
  - googleId (để link account)
  - provider: 'google' | 'local'
  - avatar (từ Google profile - optional)
• KHÔNG yêu cầu password khi đăng ký qua Google
• Tạo session như đăng nhập thường

1.2 Phân quyền
• Các role: Bidder, Seller, Admin
• Mỗi request cần middleware kiểm tra role
• Seller có thời hạn 7 ngày (mặc định)
• Logic kiểm tra seller hết hạn:
  - IF current_time > seller_end_date
    → KHÔNG cho tạo sản phẩm mới
    → VẪN cho xử lý các sản phẩm đã đăng
    → KHÔNG hạ quyền (vẫn là seller)

================================================================================
2. SELLER MANAGEMENT
================================================================================
2.1 Xin / mua quyền Seller
• Bidder gửi request xin quyền Seller
• Admin duyệt request
• Khi approve:
  - seller_start_date = now
  - seller_end_date = now + 7 ngày
  - role = 'seller'

2.2 Hết hạn Seller
• Logic:
  - IF current_time > seller_end_date
    → KHÔNG cho tạo sản phẩm mới
    → VẪN cho xử lý các sản phẩm đã đăng
    → Role vẫn là 'seller' (không downgrade)

================================================================================
3. PRODUCT / AUCTION ITEM
================================================================================
• Thuộc tính bắt buộc:
  - seller_id
  - name
  - description (rich text editor)
  - images (tối thiểu 3 ảnh)
  - category_id
  - start_price
  - step_price (bid_step)
  - buy_now_price (có thể null)
  - end_time
  - auto_extend (boolean)
  - allow_non_rated_bidders (boolean)
  - status (mặc định = 'active')

• Logic validate khi tạo:
  - IF seller_expired → reject (không cho tạo mới)
  - IF step_price <= 0 → reject
  - IF buy_now_price < start_price → reject
  - IF images.length < 3 → reject

3.2 Trạng thái sản phẩm
• Active → Ended / Sold / Cancelled
• Chuyển trạng thái:
  - Hết end_time → Ended
  - Mua ngay → Sold
  - Mua ngay → Sold
Admin/Seller cancel → Cancelled
================================================================================
4. LIST & SEARCH
• Hiển thị:
  - current_price (tính từ bid cao nhất hoặc start_price)
  - buy_now_price (nếu có)
  - thời gian còn lại
  - top bidder (PHẢI MASK TÊN)
  - số lượng bid
  - ngày đăng
  
• Logic mask tên:
  - NguyenVanA → *****VanA
  - (chỉ hiển thị 3-4 ký tự cuối)

4.2 Hiển thị thời gian
• IF remaining_time > 3 ngày
  → hiển thị datetime (dd/MM/yyyy HH:mm)
• ELSE
  → hiển thị countdown (còn X ngày X phút)

4.3 Tìm kiếm & lọc
• Full-text search theo tên sản phẩm
• Lọc theo category
• Sắp xếp: giá, thời gian kết thúc, số bid
• Highlight sản phẩm mới (trong N phút)
• Sắp xếp: giá, thời gian kết thúc, số bid
Highlight sản phẩm mới (trong N phút)
Phân trang
• Ảnh lớn + thumbnails (tối thiểu 3)
• current_price, buy_now_price
• Thông tin seller + rating
• Thông tin top bidder + rating
• Ngày đăng, ngày kết thúc
• Mô tả đầy đủ (rich text)
• Lịch sử append description (có timestamp)
• Lịch sử đấu giá
• Q&A
• 5 sản phẩm related (cùng category)
• Mô tả đầy đủ (rich text)
Lịch sử append description (có timestamp)
Lịch sử đấu giá
Q&A
5 sản phẩm related (cùng category)
Không bắt buộc chia tab

================================================================================
• Bất kỳ user nào cũng hỏi được (PHẢI ĐĂNG NHẬP)
• Lưu: product_id, asker_id, question, created_at
• Gửi email thông báo cho seller

6.2 Trả lời
• Logic:
  - IF current_user != seller_of_product → reject
• Lưu answer, answered_at
• Hiển thị công khai
• IF current_user != seller_of_product → reject
Lưu answer, answered_at
Hiển thị công khai
Gửi email thông báo cho tất cả người tham gia

================================================================================
• Sau khi giao dịch kết thúc (trong checkout flow)
• Seller và Bidder đánh giá lẫn nhau
• Dữ liệu đánh giá:
  - product_id
  - from_user_id
  - to_user_id
  - rating (+1 hoặc -1)
  - comment (optional)
  - type (bidder_to_seller / seller_to_bidder)
• Tính rating percentage:
  - comment (optional)
type (bidder_to_seller / seller_to_bidder)
Tính rating percentage:
positive_count / total_count * 100
================================================================================
8. AUCTION CORE – LOGIC CỐT LÕI
================================================================================
8.1 Điều kiện cho phép đấu giá
• IF product.status != 'active' → reject
• IF user.id == seller.id → reject
• IF user bị seller block → reject
• IF product.allow_non_rated_bidders == false
  AND user.rating_percent < 80% → reject

8.2 Bước giá (Bid Step)
• IF bid_amount < current_price + step_price → reject
• Suggest minimum bid = current_price + step_price
8.3 AUTO-BID (MAX BID) - QUAN TRỌNG!!!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Nguyên tắc:
• Người dùng nhập bid_amount và max_bid_amount (optional)
• max_bid_amount KHÔNG được hiển thị cho người khác
• max_bid_amount CÓ THỂ lưu trong DB (để xử lý auto-bid)
• NHƯNG KHÔNG hiển thị trong lịch sử đấu giá công khai

Dữ liệu bid trong DB:
• bidder_id
• bid_amount (giá hiển thị)
• max_bid_amount (giá tối đa - bí mật)
• is_auto_bid (boolean)
• created_at

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TRƯỜNG HỢP 1: Chưa có ai bid
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
current_price = bid_amount
top_bidder = bidder

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TRƯỜNG HỢP 2: Đã có người đang top với maxA
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
B đặt bid_amount và maxB

Logic:

A) Nếu B KHÔNG dùng auto-bid (maxB == null):
   ┌─────────────────────────────────────────────────────────┐
   │ IF bid_amount < current_price + step_price              │
   │   → REJECT (không đủ bước giá)                         │
   │                                                         │
   │ IF bid_amount <= maxA                                   │
   │   → Hệ thống tự động bid cho A lên min(bid_amount, maxA) │
   │   → top_bidder vẫn là A                                │
   │   → current_price = min(bid_amount, maxA)               │
   │                                                         │
   │ ELSE (bid_amount > maxA)                               │
   │   → B thành top_bidder                                 │
   │   → current_price = bid_amount                         │
   └─────────────────────────────────────────────────────────┘

B) Nếu B dùng auto-bid (maxB != null):
   ┌─────────────────────────────────────────────────────────┐
   │ IF maxB <= maxA                                         │
   │   → Hệ thống auto bid cho A lên min(maxB, maxA)        │
   │   → top_bidder = A                                     │
   │   → current_price = min(maxB, maxA)                     │
   │                                                         │
   │ ELSE (maxB > maxA)                                     │
   │   → B thành top_bidder                                 │
   │   → current_price = min(maxA + step_price, maxB)       │
   │   → Lưu bid với is_auto_bid = true                    │
   └─────────────────────────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TRƯỜNG HỢP 3: Người đang top đặt tiếp
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
IF bidder == top_bidder
  → Chỉ cập nhật max_bid_amount
  → current_price giữ nguyên

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TRƯỜNG HỢP 4: Hai người đặt cùng max_bid
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
→ Ai đặt sớm hơn thắng (sort by created_at ASC)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
HIỂN THỊ trong lịch sử đấu giá công khai:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ bidder_id (masked name)
✓ bid_amount (giá hiển thị)
✓ created_at
✓ is_auto_bid (có thể hiển thị icon)
✗ KHÔNG HIỂN THỊ max_bid_amount
================================================================================
9. GIA HẠN PHIÊN ĐẤU GIÁ (ANTI-SNIPING)
================================================================================
Logic:
• IF product.auto_extend == true
  AND bid_time >= end_time - threshold_minutes
  → end_time = end_time + extend_minutes
• IF không có bid mới → KHÔNG gia hạn

Cấu hình:
• threshold_minutes: Thời gian ngưỡng trước khi kết thúc (mặc định 5 phút)
• extend_minutes: Thời gian gia hạn thêm (mặc định 10 phút)
• PHẢI lưu trong DB hoặc config file (.env)
• PHẢI cho phép admin thay đổi

================================================================================
10. GIÁ MUA NGAY (BUY NOW)
================================================================================
10.1 Người dùng click mua ngay
• Kiểm tra:
  - IF product.buy_now_price == null → reject
  - IF user == seller → reject
  - IF product.status != 'active' → reject
  
• Xử lý:
  - status = 'sold'
  - winner = buyer
  - end_time = now
  - Tạo transaction ngay

10.2 Auto buy khi max_bid >= buy_now_price
• IF max_bid_amount >= buy_now_price
  → Hệ thống tự động chuyển sang mua ngay
  → YÊU CẦU CONFIRM từ user
  → Nếu confirm: xử lý như 10.1

================================================================================
11. KẾT THÚC ĐẤU GIÁ
• Chạy định kỳ (mỗi phút hoặc 10 phút)
• IF now > end_time AND status == 'active'
  → status = 'ended'
  → winner = top_bidder (nếu có bid)
  → Tạo transaction
  → winner = top_bidder (nếu có bid)
→ Tạo transaction
→ Gửi email thông báo

================================================================================
12. GIAO DỊCH & HỦY (CHECKOUT FLOW)
• Step 1: Bidder submit payment proof + shipping address
• Step 2: Seller confirm payment + tracking info
• Step 3: Bidder confirm delivery
• Step 4: Rating lẫn nhau

12.2 Seller hủy giao dịch
• Logic:
  - IF status == 'payment_confirmed' → reject (đã confirm payment)
  - ELSE:
    → cho phép hủy
    → Tự động rate -1 cho winner
    → cho phép hủy
→ Tự động rate -1 cho winner
→ Comment: "Buyer did not complete payment"

================================================================================
• extend_threshold_minutes
• extend_duration_minutes
• new_product_highlight_minutes
• default_auction_duration_days
• min_bidder_rating_percent

Logic:
• CÓ THỂ lưu trong DB (tốt nhất)
• HOẶC lưu trong .env file (chấp nhận được)
• Logic:
CÓ THỂ lưu trong DB (tốt nhất)
HOẶC lưu trong .env file (chấp nhận được)
QUAN TRỌNG: Phải cho phép thay đổi được

• Thêm sản phẩm vào watchlist
• Xem danh sách watchlist
• ================================================================================
User có thể:
Thêm sản phẩm vào watchlist
Xem danh sách watchlist
Xóa khỏi watchlist

• Thêm mô tả bổ sung (không thay thế)
• Lưu kèm timestamp

15.2 Block bidder
• Seller chặn bidder cụ thể khỏi sản phẩm
• Bidder bị chặn không đấu giá được
• Lưu kèm timestamp
15.2 Block bidder
Seller chặn bidder cụ thể khỏi sản phẩm
Bidder bị chặn không đấu giá được
Nếu bidder đang top → revert về bid thứ 2
• Bid mới → seller, bidder mới, bidder cũ (bị outbid)
• Bidder bị block
• Auction kết thúc (có winner) → seller + winner
• Auction kết thúc (không winner) → seller
• Câu hỏi mới → seller
• Bid mới → seller, bidder mới, bidder cũ (bị outbid)
Bidder bị block
Auction kết thúc (có winner) → seller + winner
Auction kết thúc (không winner) → seller
Câu hỏi mới → seller
Câu trả lời mới → tất cả người tham gia
ELSE
→ cho phép hủy
ADMIN CONFIG
Admin cấu hình:
extend_minutes
default_bid_step
Logic:
Lưu config trong DB
Load config khi xử lý bid
CÁC LỖI DỄ MẤT ĐIỂM
Không làm auto-bid
Không gia hạn phiên đấu giá
Hiển thị max_bid
Không áp dụng bước giá
Không mask tên bidder
KẾT THÚC TODO LIST