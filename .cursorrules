# Cursor Rules for Express + Handlebars Project

## üî¥ CRITICAL: CODE CONSISTENCY WORKFLOW

**BEFORE writing ANY code, you MUST:**

1. **Read 1-2 related files first** to understand the existing style
   - Writing a route? Read another route file in the same folder
   - Writing a service? Read another service file
   - Writing a view? Read another view in the same folder
   - Writing a util? Read another util file

2. **Match the existing patterns EXACTLY:**
   - Same indentation (2 spaces for .handlebars, standard for .js)
   - Same naming conventions (camelCase, kebab-case)
   - Same error handling approach (`res.error()` or `res.locals.err_messages`)
   - Same HTML attribute formatting (each on separate line)
   - Same Tailwind class patterns (Apple-like design)
   - Same async/await patterns (`return await` in services)

3. **Verify consistency:**
   - Does your code look identical in style to existing files?
   - Are you using the same helper functions/utils?
   - Are you following the same route‚Üíservice‚Üímodel flow?

**DO NOT write code without reading related files first!**

---

## Project Overview

Express.js 5 + Handlebars + MongoDB/Mongoose + TailwindCSS. All code, comments, UI in **English only**.

**Stack:** Session-based auth (no JWT), bcryptjs, express-validator, method-override, nodemailer, reCAPTCHA.

---

## Architecture Patterns

### Routes (`/routes/*.route.js`)
```javascript
// Pattern: router.METHOD('/path', [middleware], async function(req, res))
import express from 'express';
import * as service from '../services/resource.service.js';
import { isAuth, isAdmin } from '../middlewares/auth.mdw.js';

const router = express.Router();

// Sync route (no async needed)
router.get('/path', function (req, res) {
  res.render('view');
});

// Async route
router.post('/path', isAuth, async function (req, res) {
  const data = await service.findById(id);
  if (!data) return res.error('Not found.');
  res.redirect('/success');
});

export default router;
```

**Rules:**
- HTTP methods: POST (create), PUT (update), DELETE (delete)
- Use `res.error('msg')` for errors (redirects back automatically)
- Use `res.render('view', { data })` for views
- Use `res.redirect('/path')` for navigation
- **NEVER pass `authUser`** - already in `res.locals.authUser`
- GET routes without async: `function(req, res)`
- Route index: `/routes/index.js` mounts all routers
- Admin routes: `/routes/admin/index.js` mounts admin routers

### Services (`/services/*.service.js`)
```javascript
// Pattern: Pure DB operations, export individual async functions
import Model from '../models/Model.js';

export async function findById(id) {
  return await Model.findById(id);
}

export async function findAll(page = 1, limit = 10) {
  const skip = (page - 1) * limit;
  const items = await Model.find().sort({ createdAt: -1 }).skip(skip).limit(limit);
  const total = await Model.countDocuments();
  return {
    items,
    pagination: { page, limit, total, totalPages: Math.ceil(total / limit) },
  };
}

export async function create(data) {
  const entity = new Model(data);
  return await entity.save();
}

export async function update(id, data) {
  return await Model.findByIdAndUpdate(id, data, { new: true });
}

export async function remove(id) {
  return await Model.findByIdAndDelete(id);
}
```

**Naming conventions:**
- `findById(id)`, `findByEmail(email)`, `findByName(name)` - Single record
- `findAll(page, limit, filters)` - Paginated list
- `create(data)` or `add(data)` - Create new
- `update(id, data)` - Update existing
- `remove(id)` - Delete (avoid `delete` keyword)
- `updateStatus()`, `updatePassword()`, `updateRole()` - Specific updates

**Always return pagination:** `{ items, pagination: { page, limit, total, totalPages } }`

### Middleware (`/middlewares/*.mdw.js`)
```javascript
// Export individual functions
export function isAuth(req, res, next) {
  if (!req.session.isAuthenticated) {
    req.session.retUrl = req.originalUrl;
    return res.redirect('/auth/login');
  }
  next();
}

export function isAdmin(req, res, next) {
  if (req.session.authUser?.role !== 'admin') {
    return res.render('403');
  }
  next();
}

// Error middleware (in app.js)
export function handleError(req, res, next) {
  res.error = function (message) {
    req.session.err_messages = Array.isArray(message) ? message : [message];
    return redirectBack(req, res);
  };
  next();
}
```

### Utils (`/utils/*.js`)
```javascript
// Pure utility functions - no business logic
export function generateOTP() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

export function redirectBack(req, res, fallback = '/') {
  const referer = req.get('Referer');
  return res.redirect(referer || fallback);
}

export async function sendOTPEmail(email, code, type) {
  // Email sending logic
  try {
    await transporter.sendMail({ from, to: email, subject, text });
    return true;
  } catch (error) {
    console.error('Email error:', error);
    return false;
  }
}
```

**Utils:** `otp.js`, `email.js`, `redirect.js`, `recaptcha.js`, `pagination.js`, `db.js`

### Models (`/models/*.js`)
```javascript
// Mongoose schemas with timestamps
import mongoose from 'mongoose';

const schema = new mongoose.Schema({
  name: { type: String, required: true },
  email: { type: String, required: true, unique: true },
  role: { type: String, enum: ['bidder', 'seller', 'admin'], default: 'bidder' },
  parentId: { type: mongoose.Schema.Types.ObjectId, ref: 'Category', default: null },
}, { timestamps: true }); // Auto createdAt/updatedAt

export default mongoose.model('Model', schema);
```

**Rules:**
- Always `timestamps: true` (auto `createdAt`/`updatedAt`)
- Use `enum` for role/status fields
- Use `ref` for ObjectId references
- Use `default` for optional fields

---

## Session Management

```javascript
// Set session
req.session.isAuthenticated = true;
req.session.authUser = user; // Full Mongoose object

// Access in routes
const userId = req.session.authUser._id;

// Access in views
{{authUser.name}} // Already in res.locals.authUser

// Temporary data
req.session.registerData = { name, email, password };
delete req.session.registerData; // Cleanup after use
```

**Rules:**
- **NEVER pass `authUser` to `res.render()`** - already in `res.locals`
- Pass Mongoose objects directly (configured to allow proto properties)
- Update session when user data changes

---

## Error Handling

**Preferred pattern (redirects back):**
```javascript
if (!item) return res.error('Item not found.');
```

**For forms (stays on page):**
```javascript
res.locals.err_messages = ['Invalid email or password.'];
return res.render('vwAuth/login');
```

**Client-side (JS):**
```javascript
window.errorMessage = 'Password mismatch.';
// Auto-displays on page load
```

**Error display:** Fixed top-right, red alerts, `bg-red-50 border-red-200 text-red-900 rounded-2xl`

---

## Handlebars Templates (`/views/*.handlebars`)

### Formatting Rules (STRICT)
```handlebars
{{!-- 2 spaces indentation, NO blank lines --}}
<form
  method="post"
  action="/path"
  id="formId"
  class="space-y-6"
>
  <div class="relative mb-6">
    <label for="name" class="block text-sm font-medium text-gray-900 mb-2">Name</label>
    <input
      type="text"
      id="name"
      name="name"
      class="w-full px-4 py-4 border border-gray-200/60 rounded-2xl focus:ring-2 focus:ring-black/10 focus:outline-none transition-all duration-300 text-gray-900"
      placeholder="Enter name"
      {{#if user}}
        value="{{user.name}}"
      {{/if}}
      required
    />
  </div>
  <button
    type="submit"
    class="w-full px-6 py-4 bg-blue-600 text-white rounded-xl shadow-[0_4px_20px_rgba(37,99,235,0.3)] hover:bg-blue-700 hover:scale-105 hover:shadow-lg transition-all duration-300 ease-out font-medium"
  >
    Submit
  </button>
</form>
```

**MUST follow:**
- **Each HTML attribute on separate line** (form, input, select, button, a, div)
- **2 spaces indentation** (not tabs, not 4 spaces)
- **NO blank lines** - keep compact
- **Handlebars logic on separate lines** (not inline)
- ‚ùå Bad: `<input type="text" id="name" name="name" class="..." required />`
- ‚úÖ Good: Each attribute on new line (see example above)

### Form Methods
```handlebars
{{!-- POST for create --}}
<form method="post" action="/admin/resource">

{{!-- PUT for update --}}
<form method="post" action="/admin/resource/{{id}}">
  <input type="hidden" name="_method" value="PUT">

{{!-- DELETE (with confirmation) --}}
<form
  method="post"
  action="/admin/resource/{{id}}"
  onsubmit="return confirm('Are you sure?');"
>
  <input type="hidden" name="_method" value="DELETE">
```

### Validation
- **Backend validation is PRIMARY** (express-validator)
- **HTML5 attributes for UX only**: `required`, `type`, `step`, `min`, `max`, `pattern`
- Backend MUST validate even if HTML5 validates

---

## UI/UX Design System (Apple-like)

### Design Tokens
```css
/* Containers */
bg-white rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-gray-200/60

/* Buttons - Primary/Action */
bg-blue-600 text-white rounded-xl shadow-[0_4px_20px_rgba(37,99,235,0.3)] 
hover:bg-blue-700 hover:scale-105 hover:shadow-lg transition-all duration-300 ease-out

/* Buttons - Destructive (delete, deny) */
bg-red-600 text-white border border-red-600 rounded-xl 
shadow-[0_4px_20px_rgba(239,68,68,0.3)] hover:bg-red-700 hover:scale-105

/* Inputs */
w-full px-4 py-4 border border-gray-200/60 rounded-2xl 
focus:ring-2 focus:ring-black/10 focus:outline-none transition-all duration-300

/* Typography */
Titles: text-[28px] font-semibold text-gray-900
Body: text-gray-600
```

**Rules:**
- **Pure Tailwind only** - NO custom CSS, NO DaisyUI
- **Lots of whitespace** - generous padding/margins
- **Large rounded corners** - `rounded-2xl`, `rounded-3xl`
- **Soft shadows** - `shadow-[0_4px_20px_rgba(...)]`
- **Smooth transitions** - `transition-all duration-300 ease-out`
- **Always include hover scale** - `hover:scale-105`

---

## Pagination (Default for ALL lists)

**Service:**
```javascript
export async function findAll(page = 1, limit = 10) {
  const skip = (page - 1) * limit;
  const items = await Model.find().sort({ createdAt: -1 }).skip(skip).limit(limit);
  const total = await Model.countDocuments();
  return { items, pagination: { page, limit, total, totalPages: Math.ceil(total / limit) } };
}
```

**Route:**
```javascript
router.get('/', async function(req, res) {
  const page = parseInt(req.query.page) || 1;
  const result = await service.findAll(page, 10);
  res.render('view', { ...result });
});
```

**View:**
```handlebars
{{#if items.length}}
  {{!-- Content --}}
  <div class="p-6">
    {{{pagination pagination.page pagination.totalPages pagination.total}}}
  </div>
{{else}}
  <div class="bg-white rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-gray-200/60 p-12 text-center">
    <i class="fas fa-folder-open text-gray-400 text-6xl mb-4"></i>
    <p class="text-gray-600 text-lg">No items found.</p>
  </div>
{{/if}}
```

---

## Admin Patterns

### Admin Index (`/routes/admin/index.js`)
```javascript
import express from 'express';
import sellerRequestsRouter from './seller-requests.route.js';
import categoriesRouter from './categories.route.js';

const router = express.Router();

router.get('/', function (req, res) {
  res.redirect('/admin/seller-requests');
});

router.use('/seller-requests', sellerRequestsRouter);
router.use('/categories', categoriesRouter);

export default router;
```

### Admin CRUD Pattern
```javascript
// List
router.get('/', async function(req, res) {
  const page = parseInt(req.query.page) || 1;
  const result = await service.findAll(page, 10);
  res.render('vwAdmin/resource/index', { ...result });
});

// Create GET
router.get('/create', function(req, res) {
  res.render('vwAdmin/resource/create');
});

// Create POST
router.post('/create', async function(req, res) {
  await service.create(req.body);
  res.redirect('/admin/resource');
});

// Edit GET
router.get('/:id/edit', async function(req, res) {
  const resource = await service.findById(req.params.id);
  if (!resource) return res.status(404).render('404');
  res.render('vwAdmin/resource/edit', { resource });
});

// Update PUT
router.put('/:id', async function(req, res) {
    const resource = await service.findById(req.params.id);
  if (!resource) return res.status(404).render('404');
  await service.update(req.params.id, req.body);
  res.redirect('/admin/resource');
});

// Delete DELETE
router.delete('/:id', async function(req, res) {
  const resource = await service.findById(req.params.id);
  if (!resource) return res.error('Resource not found.');
  await service.remove(req.params.id);
  res.redirect('/admin/resource');
});
```

**Admin View Layout:**
```handlebars
{{#> admin-management-layout activeMenu='categories'}}
  <div class="mb-8">
    <h1 class="text-[36px] font-semibold text-gray-900">Title</h1>
  </div>
  {{!-- Content --}}
{{/admin-management-layout}}
```

---

## Code Style

### Naming Conventions
- **Functions:** camelCase (`findByUsername`, `isAuthenticated`)
- **Files:** kebab-case (`account.route.js`, `auth.mdw.js`, `login.handlebars`)
- **DB collections:** lowercase plural (`users`, `categories`)
- **Mongoose models:** PascalCase (`User.js`, `Category.js`)

### Organization
```
/routes/*.route.js          # Routes (auth, account, admin/*)
/services/*.service.js      # DB operations (user, category, otp)
/models/*.js                # Mongoose schemas (User, Category, OTP)
/middlewares/*.mdw.js       # Middleware (auth, error)
/utils/*.js                 # Utilities (otp, email, redirect, pagination)
/views/vw*/*.handlebars     # Views by feature (vwAuth, vwAccount, vwAdmin)
```

### Async/Await
- Always use `async/await`
- Services: `return await Model.find()`
- Routes: `async function(req, res)`
- Utils: `async` only when needed

### Comments
- **Minimize comments** - code should be self-explanatory
- **Only comment complex logic** - algorithms, edge cases
- **No obvious comments** - don't state what code shows
- **TODO comments OK** - for future notes

---

## Security & Validation

### Validation (express-validator)
```javascript
import { body } from 'express-validator';
import { handleValidationErrors } from '../middlewares/validation.mdw.js';

router.post('/register', [
  body('name').trim().isLength({ min: 2, max: 100 }),
  body('email').trim().isEmail().normalizeEmail(),
  body('password').isLength({ min: 6, max: 50 }),
  handleValidationErrors('vwAuth/register'),
], async function(req, res) {
  // Handler
});
```

### Authentication
- **bcryptjs:** `bcrypt.hashSync(password, 10)`, `bcrypt.compareSync(plain, hashed)`
- **Session-based:** No JWT
- **Roles:** `'bidder'`, `'seller'`, `'admin'`

---

## Quick Reference Files

**Before coding, read these for reference:**
- Routes: `/routes/auth.route.js`, `/routes/admin/categories.route.js`
- Services: `/services/user.service.js`, `/services/category.service.js`
- Views: `/views/vwAuth/login.handlebars`, `/views/vwAdmin/categories/index.handlebars`
- Utils: `/utils/otp.js`, `/utils/email.js`, `/utils/redirect.js`

---

## Critical Reminders

1. ‚úÖ **Read 1-2 related files before writing code**
2. ‚úÖ **Match existing style exactly** (indentation, naming, patterns)
3. ‚úÖ **Backend validation is primary** (HTML5 for UX only)
4. ‚úÖ **Use `res.error()` for errors** (not manual redirectBack)
5. ‚úÖ **Never pass `authUser` to views** (already in `res.locals`)
6. ‚úÖ **Separate create/edit views** (no shared forms)
7. ‚úÖ **Use proper HTTP methods** (POST/PUT/DELETE)
8. ‚úÖ **All lists have pagination** (10 items/page)
9. ‚úÖ **Each HTML attribute on separate line**
10. ‚úÖ **Pure Tailwind only** (no DaisyUI, no custom CSS)
11. ‚úÖ **Apple-like design** (whitespace, rounded corners, soft shadows)
12. ‚úÖ **Delete forms need confirmation** (`onsubmit="return confirm(...)"`)
13. ‚úÖ **Timestamps: true** (no manual `createdAt`)
14. ‚úÖ **English only** (code, comments, UI)
15. ‚úÖ **Act as senior engineer** (clean, maintainable, production-ready)

---

**Remember: CONSISTENCY IS KEY. Always read existing files first to match the style!**
