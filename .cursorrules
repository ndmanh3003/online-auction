# Cursor Rules for Express + Handlebars Project

## üî¥ CRITICAL: CODE CONSISTENCY WORKFLOW

**BEFORE writing ANY code, you MUST:**

1. **Read 1-2 related files first** to understand the existing style

   - Writing a route? Read another route file in the same folder
   - Writing a service? Read another service file
   - Writing a view? Read another view in the same folder
   - Writing a util? Read another util file

2. **Match the existing patterns EXACTLY:**

   - Same indentation (2 spaces for .handlebars, standard for .js)
   - Same naming conventions (camelCase, kebab-case)
   - NO SEMICOLONS in JavaScript files
   - Same HTML attribute formatting (each on separate line)
   - Same Tailwind class patterns (Apple-like design)
   - Same async/await patterns (`return await` in services)

3. **Verify consistency:**
   - Does your code look identical in style to existing files?
   - Are you using the same helper functions/utils?
   - Are you following the same route‚Üíservice‚Üímodel flow?

**DO NOT write code without reading related files first!**

---

## Project Overview

Express.js 5 + Handlebars + MongoDB/Mongoose + TailwindCSS. All code, comments, UI in **English only**.

**Stack:** Session-based auth (no JWT), bcryptjs, method-override, nodemailer.

**Code Style:** NO SEMICOLONS - All JavaScript files use semicolon-free style.

---

## Architecture Patterns

### Routes (`/routes/*.route.js`)

```javascript
// Pattern: router.METHOD('/path', [middleware], async function(req, res))
import express from 'express'
import * as service from '../services/resource.service.js'
import { isAuth, isAdmin } from '../middlewares/auth.mdw.js'

const router = express.Router()

// Sync route (no async needed)
router.get('/path', function (req, res) {
  res.render('view')
})

// Async route (happy case - assume valid data)
router.post('/path', isAuth, async function (req, res) {
  const data = await service.findById(id)
  res.redirect('/success')
})

export default router
```

**Rules:**

- HTTP methods: POST (create), PUT (update), DELETE (delete)
- NO SEMICOLONS - use semicolon-free style
- **No input validation** - assume client data is valid (no 404 checks, no existence checks)
- **Use `res.error('msg')` for business logic errors** (seller can't bid on own product, etc.)
- Use `res.render('view', { data })` for views
- Use `res.redirect('/path')` for navigation
- **NEVER pass `authUser`** - already in `res.locals.authUser`
- **NEVER pass `allCategories`** - already in `res.locals.allCategories`
- GET routes without async: `function(req, res)`
- Route index: `/routes/index.js` mounts all routers
- Admin routes: `/routes/admin/index.js` mounts admin routers

### Services (`/services/*.service.js`)

```javascript
// Pattern: Pure DB operations, export individual async functions
import Model from '../models/Model.js'

export async function findById(id) {
  return await Model.findById(id).populate('relatedField')
}

export async function findAll(page = 1, limit = 10) {
  const skip = (page - 1) * limit
  const items = await Model.find()
    .sort({ createdAt: -1 })
    .skip(skip)
    .limit(limit)
  const total = await Model.countDocuments()
  return {
    items,
    pagination: { page, limit, total, totalPages: Math.ceil(total / limit) },
  }
}

export async function create(data) {
  const entity = new Model(data)
  return await entity.save()
}

export async function update(id, data) {
  return await Model.findByIdAndUpdate(id, data, { new: true })
}

export async function remove(id) {
  return await Model.findByIdAndDelete(id)
}
```

**Naming conventions:**

- `findById(id)`, `findByEmail(email)` - Single record
- `findAll(page, limit, filters)` - Paginated list
- `create(data)` or `add(data)` - Create new
- `update(id, data)` - Update existing
- `remove(id)` - Delete (avoid `delete` keyword)
- `updateStatus()`, `updatePassword()`, `updateRole()` - Specific updates

**Populate Strategy:**

- Always populate ALL fields when using `.populate()` (no field selection)
- Example: `.populate('categoryId')` not `.populate('categoryId', 'name')`
- Let the client/view decide what to use

**Always return pagination:** `{ items, pagination: { page, limit, total, totalPages } }`

### Middleware (`/middlewares/*.mdw.js`)

```javascript
// Export individual functions
export function isAuth(req, res, next) {
  if (!req.session.isAuthenticated) {
    req.session.retUrl = req.originalUrl
    return res.redirect('/auth/login')
  }
  next()
}

export function isAdmin(req, res, next) {
  if (req.session.authUser?.role !== 'admin') {
    return res.render('403')
  }
  next()
}

export function isSeller(req, res, next) {
  if (
    req.session.authUser?.role !== 'seller' &&
    req.session.authUser?.role !== 'admin'
  ) {
    return res.render('403')
  }
  next()
}

// Error middleware (in app.js)
export function handleError(req, res, next) {
  res.error = function (message) {
    req.session.err_messages = Array.isArray(message) ? message : [message]
    return redirectBack(req, res)
  }
  next()
}
```

### Utils (`/utils/*.js`)

```javascript
// Pure utility functions - no business logic
export function generateOTP() {
  return Math.floor(100000 + Math.random() * 900000).toString()
}

export function redirectBack(req, res, fallback = '/') {
  const referer = req.get('Referer')
  return res.redirect(referer || fallback)
}

export async function sendOTPEmail(email, code, type) {
  try {
    await transporter.sendMail({ from, to: email, subject, text })
    return true
  } catch (error) {
    console.error('Email error:', error)
    return false
  }
}
```

**Utils:** `otp.js`, `email.js`, `redirect.js`, `pagination.js`, `db.js`

### Models (`/models/*.js`)

```javascript
// Mongoose schemas with timestamps
import mongoose from 'mongoose'

const schema = new mongoose.Schema(
  {
    name: { type: String, required: true },
    email: { type: String, required: true, unique: true },
    role: {
      type: String,
      enum: ['bidder', 'seller', 'admin'],
      default: 'bidder',
    },
    parentId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'Category',
      default: null,
    },
  },
  { timestamps: true }
) // Auto createdAt/updatedAt

export default mongoose.model('Model', schema)
```

**Rules:**

- Always `timestamps: true` (auto `createdAt`/`updatedAt`)
- Use `enum` for role/status fields
- Use `ref` for ObjectId references
- Use `default` for optional fields

---

## Session Management

```javascript
// Set session
req.session.isAuthenticated = true
req.session.authUser = user // Full Mongoose object

// Access in routes
const userId = req.session.authUser._id

// Access in views
{{authUser.name}} // Already in res.locals.authUser
{{#each allCategories}} // Already in res.locals.allCategories

// Temporary data
req.session.registerData = { name, email, password }
delete req.session.registerData // Cleanup after use
```

**Rules:**

- **NEVER pass `authUser` to `res.render()`** - already in `res.locals.authUser`
- **NEVER pass `allCategories` to `res.render()`** - already in `res.locals.allCategories`
- Pass Mongoose objects directly (configured to allow proto properties)
- Update session when user data changes

---

## Error Handling

**Happy case approach (no input validation):**

```javascript
// Assume client data is valid - no 404 checks, no existence checks
router.post('/path', async function (req, res) {
  await service.create(req.body)
  res.redirect('/success')
})
```

**Business logic errors (use res.error):**

```javascript
// For business rules violations
router.post('/bid', async function (req, res) {
  const product = await productService.findById(productId)
  if (product.sellerId.toString() === req.session.authUser._id.toString()) {
    return res.error('You cannot bid on your own product')
  }
  await bidService.create(req.body)
  res.redirect('/success')
})
```

**For forms that need validation (rare):**

```javascript
res.locals.err_messages = ['Invalid email or password.']
return res.render('vwAuth/login')
```

**Key principles:**

- No input validation (no 404 checks, no existence checks)
- Use `res.error()` for business logic violations
- Code for the happy path, handle business rules only

---

## Handlebars Templates (`/views/*.handlebars`)

### Formatting Rules (STRICT)

```handlebars
{{!-- 2 spaces indentation, NO blank lines --}}
<form
  method="post"
  action="/path"
  id="formId"
  class="space-y-6"
>
  <div class="relative mb-6">
    <label for="name" class="block text-sm font-medium text-gray-900 mb-2">Name</label>
    <input
      type="text"
      id="name"
      name="name"
      class="w-full px-4 py-4 border border-gray-200/60 rounded-2xl focus:ring-2 focus:ring-black/10 focus:outline-none transition-all duration-300 text-gray-900"
      placeholder="Enter name"
      {{#if user}}
        value="{{user.name}}"
      {{/if}}
      required
    />
  </div>
  <button
    type="submit"
    class="w-full px-6 py-4 bg-blue-600 text-white rounded-xl shadow-[0_4px_20px_rgba(37,99,235,0.3)] hover:bg-blue-700 hover:scale-105 hover:shadow-lg transition-all duration-300 ease-out font-medium"
  >
    Submit
  </button>
</form>
```

**MUST follow:**

- **Each HTML attribute on separate line** (form, input, select, button, a, div)
- **2 spaces indentation** (not tabs, not 4 spaces)
- **NO blank lines** - keep compact
- **Handlebars logic on separate lines** (not inline)
- ‚ùå Bad: `<input type="text" id="name" name="name" class="..." required />`
- ‚úÖ Good: Each attribute on new line (see example above)

### Form Methods

```handlebars
{{!-- POST for create --}}
<form method="post" action="/admin/resource">

{{!-- PUT for update --}}
<form method="post" action="/admin/resource/{{id}}">
  <input type="hidden" name="_method" value="PUT">

{{!-- DELETE (with confirmation) --}}
<form
  method="post"
  action="/admin/resource/{{id}}"
  onsubmit="return confirm('Are you sure?');"
>
  <input type="hidden" name="_method" value="DELETE">
```

### Validation

- **HTML5 validation ONLY**: `required`, `type`, `step`, `min`, `max`, `pattern`
- **No backend validation** - assume client data is always valid
- Code for happy case only

---

## UI/UX Design System (Apple-like)

### Design Tokens

```css
/* Containers */
bg-white rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-gray-200/60

/* Buttons - Primary/Action */
bg-blue-600 text-white rounded-xl shadow-[0_4px_20px_rgba(37,99,235,0.3)]
hover:bg-blue-700 hover:scale-105 hover:shadow-lg transition-all duration-300 ease-out

/* Buttons - Destructive (delete, deny) */
bg-red-600 text-white border border-red-600 rounded-xl
shadow-[0_4px_20px_rgba(239,68,68,0.3)] hover:bg-red-700 hover:scale-105

/* Inputs */
w-full px-4 py-4 border border-gray-200/60 rounded-2xl
focus:ring-2 focus:ring-black/10 focus:outline-none transition-all duration-300

/* Typography */
Titles: text-[28px] font-semibold text-gray-900
Body: text-gray-600
```

**Rules:**

- **Pure Tailwind only** - NO custom CSS, NO DaisyUI
- **Lots of whitespace** - generous padding/margins
- **Large rounded corners** - `rounded-2xl`, `rounded-3xl`
- **Soft shadows** - `shadow-[0_4px_20px_rgba(...)]`
- **Smooth transitions** - `transition-all duration-300 ease-out`
- **Always include hover scale** - `hover:scale-105`

---

## Pagination (Default for ALL lists)

**Service:**

```javascript
export async function findAll(page = 1, limit = 10) {
  const skip = (page - 1) * limit
  const items = await Model.find()
    .sort({ createdAt: -1 })
    .skip(skip)
    .limit(limit)
  const total = await Model.countDocuments()
  return {
    items,
    pagination: { page, limit, total, totalPages: Math.ceil(total / limit) },
  }
}
```

**Route:**

```javascript
router.get('/', async function (req, res) {
  const page = parseInt(req.query.page) || 1
  const result = await service.findAll(page, 10)
  res.render('view', { ...result })
})
```

**View:**

```handlebars
{{#if items.length}}
  {{! Content }}
  <div class='p-6'>
    {{{pagination pagination.page pagination.totalPages pagination.total}}}
  </div>
{{else}}
  <div
    class='bg-white rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-gray-200/60 p-12 text-center'
  >
    <i class='fas fa-folder-open text-gray-400 text-6xl mb-4'></i>
    <p class='text-gray-600 text-lg'>No items found.</p>
  </div>
{{/if}}
```

---

## Admin Patterns

### Admin Index (`/routes/admin/index.js`)

```javascript
import express from 'express'
import sellerRequestsRouter from './seller-requests.route.js'
import categoriesRouter from './categories.route.js'

const router = express.Router()

router.get('/', function (req, res) {
  res.redirect('/admin/seller-requests')
})

router.use('/seller-requests', sellerRequestsRouter)
router.use('/categories', categoriesRouter)

export default router
```

### Admin CRUD Pattern

```javascript
// List
router.get('/', async function (req, res) {
  const page = parseInt(req.query.page) || 1
  const result = await service.findAll(page, 10)
  res.render('vwAdmin/resource/index', { ...result })
})

// Create GET
router.get('/create', function (req, res) {
  res.render('vwAdmin/resource/create')
})

// Create POST (no validation needed)
router.post('/create', async function (req, res) {
  await service.create(req.body)
  res.redirect('/admin/resource')
})

// Edit GET
router.get('/:id/edit', async function (req, res) {
  const resource = await service.findById(req.params.id)
  res.render('vwAdmin/resource/edit', { resource })
})

// Update PUT (no validation needed)
router.put('/:id', async function (req, res) {
  await service.update(req.params.id, req.body)
  res.redirect('/admin/resource')
})

// Delete DELETE (no checks needed)
router.delete('/:id', async function (req, res) {
  await service.remove(req.params.id)
  res.redirect('/admin/resource')
})
```

**Admin View Layout:**

```handlebars
{{#> admin-management-layout activeMenu='categories'}}
  <div class="mb-8">
    <h1 class="text-[36px] font-semibold text-gray-900">Title</h1>
  </div>
  {{!-- Content --}}
{{/admin-management-layout}}
```

---

## Code Style

### Naming Conventions

- **Functions:** camelCase (`findByUsername`, `isAuthenticated`)
- **Files:** kebab-case (`account.route.js`, `auth.mdw.js`, `login.handlebars`)
- **DB collections:** lowercase plural (`users`, `categories`)
- **Mongoose models:** PascalCase (`User.js`, `Category.js`)

### Organization

```
/routes/*.route.js          # Routes (auth, account, admin/*, bidder/*, seller/*)
/services/*.service.js      # DB operations (user, category, otp, bid, product)
/models/*.js                # Mongoose schemas (User, Category, Product, Bid)
/middlewares/*.mdw.js       # Middleware (auth.mdw.js only)
/utils/*.js                 # Utilities (otp, email, pagination, db)
/views/vw*/*.handlebars     # Views by feature (vwAuth, vwAccount, vwAdmin)
/views/partials/            # Reusable components (category-dropdown, product-card)
```

### Async/Await

- Always use `async/await`
- Services: `return await Model.find()`
- Routes: `async function(req, res)`
- Utils: `async` only when needed
- **NO SEMICOLONS** - use semicolon-free style throughout

### Comments

- **Minimize comments** - code should be self-explanatory
- **Only comment complex logic** - algorithms, edge cases
- **No obvious comments** - don't state what code shows
- **TODO comments OK** - for future notes

---

## Security & Validation

### Validation

- **HTML5 only** - No input validation on backend
- **Business logic validation** - Use `res.error()` for business rules
- Trust client data (no 404 checks, no existence checks)
- Use HTML5 attributes: `required`, `type`, `min`, `max`, `pattern`

### Authentication

- **bcryptjs:** `bcrypt.hashSync(password, 10)`, `bcrypt.compareSync(plain, hashed)`
- **Session-based:** No JWT
- **Roles:** `'bidder'`, `'seller'`, `'admin'`
- **Middleware:** `isAuth`, `isAdmin`, `isSeller`

---

## Quick Reference Files

**Before coding, read these for reference:**

- Routes: `/routes/auth.route.js`, `/routes/admin/categories.route.js`, `/routes/bidder/bid.route.js`
- Services: `/services/user.service.js`, `/services/category.service.js`, `/services/bid.service.js`
- Views: `/views/vwAuth/login.handlebars`, `/views/vwProducts/list.handlebars`
- Partials: `/views/partials/category-dropdown.handlebars`, `/views/partials/product-card.handlebars`
- Utils: `/utils/otp.js`, `/utils/email.js`, `/utils/redirect.js`, `/utils/pagination.js`

---

## Critical Reminders

1. ‚úÖ **Read 1-2 related files before writing code**
2. ‚úÖ **Match existing style exactly** (NO SEMICOLONS, indentation, naming)
3. ‚úÖ **No input validation** - assume client data is valid (no 404, no existence checks)
4. ‚úÖ **Use `res.error()` for business logic errors** - business rules violations only
5. ‚úÖ **Never pass `authUser` or `allCategories` to views** (already in `res.locals`)
6. ‚úÖ **Separate create/edit views** (no shared forms)
7. ‚úÖ **Use proper HTTP methods** (POST/PUT/DELETE)
8. ‚úÖ **All lists have pagination** (10 items/page)
9. ‚úÖ **Each HTML attribute on separate line**
10. ‚úÖ **Pure Tailwind only** (no DaisyUI, no custom CSS)
11. ‚úÖ **Apple-like design** (whitespace, rounded corners, soft shadows)
12. ‚úÖ **Delete forms need confirmation** (`onsubmit="return confirm(...)"`)
13. ‚úÖ **Timestamps: true** (no manual `createdAt`)
14. ‚úÖ **Populate all fields** - don't specify field selections in `.populate()`
15. ‚úÖ **Use reusable partials** - category-dropdown, product-card
16. ‚úÖ **English only** (code, comments, UI)
17. ‚úÖ **Code for happy case + business rules** - no defensive checks, only business logic
18. ‚úÖ **NO SEMICOLONS** - this is critical, never use semicolons in JS files

---

**Remember: CONSISTENCY IS KEY. Always read existing files first to match the style!**
